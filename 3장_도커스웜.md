### **ğŸ–Šï¸** ê°œìš”

ë„ì»¤ ì»¨í…Œì´ë„ˆë¥¼ ìœ„í•œ í´ëŸ¬ìŠ¤í„°ë§ ë° ìŠ¤ì¼€ì¤„ë§ íˆ´, ë‹¤ì¤‘ ì„œë²„ ë° ì»¨í…Œì´ë„ˆ ê´€ë¦¬ì— ìš©ì´

## **ğŸ–Šï¸ ì‚¬ìš© ì´ìœ :** ë„ì»¤ ìŠ¤ì›œ í´ë˜ì‹ VS ë„ì»¤ ìŠ¤ì›œ ëª¨ë“œ

Docker swarm win ! 
â†’ ë¡œë“œ ë°¸ëŸ°ì‹± ê¸°ëŠ¥ ìì²´ ì œê³µ ë“± ë³´ë‹¤ í¸ë¦¬
â†’ ìŠ¤ì›œ ëª¨ë“œëŠ” ë§¤ë‹ˆì € ë…¸ë“œì˜ ì ˆë°˜ ì´ìƒì— ì¥ì•  ìƒê¸¸ ì‹œ í•´ë‹¹ ë…¸ë“œ ë³µêµ¬ë  ë•Œê¹Œì§€ í´ëŸ¬ìŠ¤í„° ìš´ì˜ ì¤‘ë‹¨ (ì°¸ê³ )

## **ğŸ–Šï¸ ë„ì»¤ ìŠ¤ì›œ ëª¨ë“œ í´ëŸ¬ìŠ¤í„° êµ¬ì¶•**

# check init status

`docker info`

# ë§¤ë‹ˆì € ë…¸ë“œ ìŠ¤ì›œ í´ëŸ¬ìŠ¤í„° ì‹œì‘, Public IPë¡œ

`docker swarm init --advertise-addr 192.168.0.100`

# add node (with each token)

`docker swarm join --tokenÂ  {token} {IP}:{port}`

# check token

`docker swarm join-token managerdocker swarm join-token worker`

# change token (for security)

`docker swarm join-token --rotate manager`

# ë…¸ë“œì˜ ìŠ¤ì›œ í´ëŸ¬ìŠ¤í„° ì„±ê³µ ì—¬ë¶€ í™•ì¸

`docker node ls`d

# change status to Down from Ready

`docker swarm leave`

`docker swarm leave --force` # manager node, delete entire worker node

# remove docker node, can be controlled by part of node ID

`docker node rm {host name or id}`

# change node type (manager <-> worker)

`docker node promoteÂ  {host name or id}`

`docker node demote {host name or id}`

â€

## **ğŸ–Šï¸ ë„ì»¤ ìŠ¤ì›œ ëª¨ë“œ ì„œë¹„ìŠ¤ (ì„œë¹„ìŠ¤ ë‹¨ìœ„ ì œì–´)**

* **ì„œë¹„ìŠ¤**ë€, ë™ì¼í•œ **ì´ë¯¸ì§€**ì—ì„œ ìƒì„±í•œ **ì»¨í…Œì´ë„ˆì˜ ì§‘í•©**ì„ ì˜ë¯¸

* ì„œë¹„ìŠ¤ ë‚´ ì»¨í…Œì´ë„ˆëŠ” ì ì–´ë„ 1ê°œ ì´ìƒ ì¡´ì¬í•´ì•¼ í•¨
* ê° ì»¨í…Œì´ë„ˆëŠ” manager ë° worker ë…¸ë“œì— **task** ë¡œì¨ í• ë‹¹
* **ë¡¤ë§ ì—…ë°ì´íŠ¸** ì§€ì›ì„œë¹„ìŠ¤ ì œì–´

# create the service

`service create {image name:version}` 
`/bin/sh -c "while true; do echo hello world; sleep 1; done`

** ë§Œì•½ ë‹¤ìŒ(`docker service create ubuntu:14.04`)ê³¼ ê°™ì´ ì„œë¹„ìŠ¤ë¥¼ ìƒì„±í•˜ë©´ 
    ì»¨í…Œì´ë„ˆ ë‚´ë¶€ë¥¼ ì°¨ì§€í•˜ê³  ìˆëŠ” í”„ë¡œì„¸ìŠ¤ê°€ ì—†ê¸° ë•Œë¬¸ì— ì»¨í…Œì´ë„ˆê°€ ì •ì§€ â†’ 
    ìŠ¤ì›œ ë§¤ë‹ˆì €ëŠ” ì„œë¹„ìŠ¤ì˜ ì»¨í…Œì´ë„ˆì— ì¥ì• ê°€ ìƒê¸´ ê²ƒìœ¼ë¡œ íŒë‹¨í•´ ì»¨í…Œì´ë„ˆ ë°˜ë³µ ìƒì„±

# check docker service

`docker service ls`

# check detail of docker service

`docker service ps {service name}`

# delete docker service

`docker service rm {service name}`

# load image to create the service without hub login using auth

`docker service create --with-registry-auth \ â€¦`

## **ğŸ–Šï¸** nginx ì›¹ ì„œë²„ ì„œë¹„ìŠ¤ ìƒì„±í•˜ê¸° ****

`service create --name myweb --replicas 2 -p 80:80 nginx`
`docker service ps myweb` 

# scale out

`service scale myweb=4`

`docker servic ps myweb`

# generate service as global mode (ê° ë…¸ë“œì— ì»¨í…Œì´ë„ˆê°€ í•˜ë‚˜ì”© ìƒì„±)

`docker service create --name global_web --mode global nginx` 
`docker service ls`
`docker service ps global_web`

## **ğŸ–Šï¸** ì„œë¹„ìŠ¤ ì¥ì•  ë³µêµ¬ ****

ì¥ì•  ë°œìƒ(ë³µì œ ëª¨ë“œë¡œ ì„¤ì •ëœ ì„œë¹„ìŠ¤ì˜ ì»¨í…Œì´ë„ˆ ì •ì§€ OR íŠ¹ì • ë…¸ë“œ ë‹¤ìš´) ì‹œ 
**ìŠ¤ì›œ ë§¤ë‹ˆì €**ê°€ **ìƒˆë¡œìš´ ì»¨í…Œì´ë„ˆë¥¼ ìƒì„±í•´ ìë™ ë³µêµ¬**

# ì‹¤ìŠµ 1) ì¸ìœ„ì ìœ¼ë¡œ í•˜ë‚˜ì˜ ì»¨í…Œì´ë„ˆë¥¼ ì§€ì›Œ ì¥ì•  ìƒí™© ë°œìƒ ì‹œí‚´
`docker ps`
`docker rm -f {container name}`

# ìŠ¤ì›œ ëª¨ë“œì˜ ì„œë¹„ìŠ¤ì—ì„œ ìƒì„±ëœ ì»¨í…Œì´ë„ˆë§Œ ì¶œë ¥

`docker ps --filter is-task=true --format {{.Names}}`

# ìƒˆë¡œìš´ ì»¨í…Œì´ë„ˆ ìƒì„± í™•ì¸

`docker service ps myweb`

# ì¸ìœ„ì ìœ¼ë¡œ í•˜ë‚˜ì˜ ë„ì»¤ ë°ëª¬ ì¢…ë£Œí•´ ì¥ì•  ìƒí™© ë°œìƒ

# ë³µêµ¬ìš© ì»¨í…Œì´ë„ˆê°€ swarm-manager ë…¸ë“œì— ìƒì„±

- ì£¼ì˜
    
    ë‹¤ìš´ëë˜ ë…¸ë“œë¥¼ ë³µêµ¬í•˜ë”ë¼ë„ ìƒˆë¡œìš´ ë…¸ë“œë¡œ ì´ê´€ëœ ì»¨í…Œì´ë„ˆê°€ 
    ì›ë³¸ ë…¸ë“œì— ìë™ìœ¼ë¡œ ë³µêµ¬/í• ë‹¹ë˜ì§€ ì•ŠìŒ
    

`service docker stop docker stop/waitingdocker node ls`

`docker service ps` 

# ì»¨í…Œì´ë„ˆ í• ë‹¹ ê· í˜• ë§ì¶”ê¸° ìœ„í•´ ìˆ˜ë™ìœ¼ë¡œ ìŠ¤ì¼€ì¼ë§ í•´ì•¼ í•¨
`docker service scale myweb=1`

`docker service scale myweb=4`

â€

## **ğŸ–Šï¸** ì„œë¹„ìŠ¤ ë¡¤ë§ ì—…ë°ì´íŠ¸

(ì—…ë°ì´íŠ¸ ì‹¤ìŠµ ìŠ¤íŠ¸ë¦½íŠ¸ë¡œ ì†ë„ ë° ê³¼ì • í™•ì¸)

# ë¡¤ë§ ì—…ë°ì´íŠ¸ë¥¼ í…ŒìŠ¤íŠ¸í•˜ê¸° ìœ„í•œ ì„œë¹„ìŠ¤ ìƒì„±

`docker service create --name myweb2 --replicas 3 nginx:1.10`

# ìƒì„±ëœ ì„œë¹„ìŠ¤ì˜ ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸

`docker service update --image nginx:1.11 myweb2`

# ê²°ê³¼ í™•ì¸

`docker service ps myweb2`

# ë¡¤ë§ ì—…ë°ì´íŠ¸ ì˜µì…˜ ì¡°ì‘

`docker service create \ --replicas 4 \ --name myweb3 \ --update-delay 10s \ --update-parallelism 2 \ nginx:1.10`

# ë¡¤ë§ ì—…ë°ì´íŠ¸ ì˜µì…˜ í™•ì¸

`docker service inspect --pretty myweb3`

# ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ ëŒ€ì‘ (ì¤‘ë‹¨ or ì§€ì†)

`docker service create --name myweb4 --replicas 4 --update-failure-action continue nginx:1.10`

# ë¡¤ë°±(rollback) - ì„œë¹„ìŠ¤ ë¡¤ë§ ì—…ë°ì´íŠ¸ í›„ ì„œë¹„ìŠ¤ë¥¼ ë¡¤ë§ ì—…ë°ì´íŠ¸ ì „ìœ¼ë¡œ ë³µêµ¬

`docker service rollback myweb3`

â€

## **ğŸ–Šï¸** ì„œë¹„ìŠ¤ ì»¨í…Œì´ë„ˆì— ì„¤ì • ì •ë³´ ì „ë‹¬: config, secret

# ì»¨í…Œì´ë„ˆ ë‹¨ìœ„ - ë³¼ë¥¨ì„ í†µí•´ ì „ë‹¬ (before)

```bash
docker run -d --name yml_registry -p 5002:5000 --restart=always -v 
$(pwd)/config.yml:/etc/docker/registry/config.yml registry:2.6
```

# ì»¨í…Œì´ë„ˆ ë‹¨ìœ„ - e ì˜µì…˜ì„ í†µí•œ í™˜ê²½ë³€ìˆ˜ ì „ë‹¬ (before)

```bash
.docker run -d \
--name wordpressdb_hostvolume \
- e MYSQL_ROOT_PASSWORD=password \
- e MYSQL_DATABASE=wordpress \
- v /home/wordpress_db:/var/lib/mysql \ 
mysql:5.7
```

# í´ëŸ¬ìŠ¤ì»¤ ë‹¨ìœ„ (ìŠ¤ì›œ ëª¨ë“œ) - secret, config ê¸°ëŠ¥

â†’ ì„¤ì • íŒŒì¼ì„ í˜¸ìŠ¤íŠ¸ë§ˆë‹¤ ê´€ë¦¬í•˜ëŠ” ê²ƒ, ë¹„íš¨ìœ¨ì 

â†’ ë¹„ë°€ë²ˆí˜¸ì™€ ê°™ì´ ë¯¼ê°í•œ ì •ë³´ë¥¼ í™˜ê²½ ë³€ìˆ˜ë¡œ ì„¤ì •í•˜ëŠ” ê²ƒ, ë³´ì•ˆìƒìœ¼ë¡œë„ ì·¨ì•½

â†’ secret íŒŒì¼ì€ ì»¨í…Œì´ë„ˆ ë°°í¬ í›„ì—ë„ íŒŒì¼ ì‹œìŠ¤í…œ ì•„ë‹Œ ë©”ëª¨ë¦¬ì— ì €ì¥ë˜ê¸° ë•Œë¬¸ì— 
   ì„œë¹„ìŠ¤ ì»¨í…Œì´ë„ˆê°€ ì‚­ì œë˜ë©´ secretë„ í•¨ê»˜ ì‚­ì œë˜ëŠ” íœ˜ë°œì„± ê°€ì§

â†’ ë‹¨, secretê³¼ configëŠ” ìŠ¤ì›œ ëª¨ë“œì—ì„œë§Œ ì‚¬ìš©ë  ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ì´ë©° 
    docker run ëª…ë ¹ì–´ì—ì„œëŠ” ì‚¬ìš©í•  ìˆ˜ ì—†ìŒ

1ï¸âƒ£ secret ì‹¤ìŠµ

# ìƒì„± ë° ì„¤ì •

`echo 1q2w3e4r | docker secret create my_mysql_password -`

# secret í™•ì¸

`docker secret ls`

# secret í™•ì¸ (json format)

`docker secret inspect my_mysql_password`

# mysql pwë¥¼ ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì— ë§ˆìš´íŠ¸ (ê¸°ë³¸ - /run/secrets/, ì„¤ì • - ì ˆëŒ€ê²½ë¡œ)

ë‹¨, í•´ë‹¹ ì»¨í…Œì´ë„ˆê°€ `-e MYSQL_PASSWORD_FILE=â€/run/secrets/mysql_passwordâ€`ì™€ ê°™ì´ í•´ë‹¹ íŒŒì¼ ì°¸ì¡°í•˜ë„ë¡ ì„¤ì •í•´ ì¤˜ì•¼ í•¨

```bash
docker service create \ --name mysql \
--replicas 1 \
--secret source=my_mysql_password,target=mysql_root_password \ 
--secret source=my_mysql_password,target=mysql_password \
-e MYSQL_ROOT_PASSWORD_FILE="/run/secrets/mysql_root_password" \ 
-e MYSQL_PASSWORD_FILE="/run/secrets/mysql_password" \ 
-e MYSQL_DATABASE="wordpress" \ 
mysql:5.7 \
```

2ï¸âƒ£ config ì‹¤ìŠµ (secretì™€ ì°¨ì´ì  - Data í•­ëª© ì¡´ì¬)

# ìƒì„± ë° ì„¤ì •

`docker config create registry-config config.yml`

# config í™•ì¸
`docker config ls`

`docker config inspect registry-config`

# ë°ì´í„° ë””ì½”ë”©

**( configëŠ” ì…ë ¥ëœ ê°’ì„ base64ë¡œ ì¸ì½”ë”©í•œ ë’¤ ì €ì¥í•˜ê¸° ë•Œë¬¸ì— base64 ëª…ë ¹ì–´ ë””ì½”ë”© í•„ìš” )**

`echo dmVyc2lvbjogâ€¦ | base64 -d`

# config í™œìš©í•˜ì—¬ ì‚¬ì„¤ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ìƒì„±

```bash
docker service create --name yml_registry -p 5000:5000 \ 
--config source=registry-config,target=/etc/docker/registry/config.yml \ 
registry:2.6
```

# config / secret ìˆ˜ì • í•„ìš”í•  ì‹œ ?

docker service update ëª…ë ¹ì–´ì˜ --config-rm, --config-add, --secret-rm, --secretadd ì˜µì…˜ ì‚¬ìš©

## **ğŸ–Šï¸ Docker Swarm Network (;** Overlay Network)

Overlay Network ë€, ë„ì»¤ ë°ëª¬ í˜¸ìŠ¤íŠ¸ë“¤ ê°„ì— ë¶„ì‚° ë„¤íŠ¸ì›Œí¬ ìƒì„±í•´ ì£¼ëŠ” **ë“œë¼ì´ë²„,**

ì»¨í…Œì´ë„ˆ ê°„ì˜ í†µì‹  ë° ì•ˆì „í•œ í†µì‹  ì§€ì›, ë„ì»¤ ë‚´ ëª¨ë“  íŒ¨í‚· íˆ¬ëª…í•œ ì²˜ë¦¬ ë‹´ë‹¹,

**ingress** ë„¤íŠ¸ì›Œí¬ì™€ **docker_gwbridge**

(ì²˜ìŒìœ¼ë¡œ Swarm ì´ˆê¸°í™” ì‹œ ìë™ìœ¼ë¡œ ìƒì„±ë˜ëŠ” ë‘ ê°œì˜ ë„¤íŠ¸ì›Œí¬)

ğŸ’¡ **í•™ìŠµ ì´ìœ  1 -** ë„¤íŠ¸ì›Œí¬ ë“œë¼ì´ë²„ë¡œ ë¬¶ì—¬ìˆì–´ì•¼ë§Œ ì»¨í…Œì´ë„ˆ ê°„ í†µì‹  ê°€ëŠ¥

ğŸ’¡ **í•™ìŠµ ì´ìœ  2**

 **â†’** ì˜¤ë²„ë ˆì´ ë„¤íŠ¸ì›Œí¬ì— ì—°ê²°ëœ ì„œë¹„ìŠ¤ì™€ ë…ë¦½ì‹¤í–‰í˜• ì»¨í…Œì´ë„ˆëŠ” ë™ì¼í•œ ì˜¤ë²„ë ˆì´ ë„¤íŠ¸ì›Œí¬ì— ì—°ê²°ë˜ì–´ ìˆì„ì§€ë¼ë„ ê¸°ë³¸ ë™ì‘ê³¼ ì„¤ì •ì´ ë‹¤ë¥´ê¸° ë•Œë¬¸ì— ì¡°ì‘ í•„ìš”

1ï¸âƒ£ ingress

â†’ ì»¨í…Œì´ë„ˆë¥¼ ì™¸ë¶€ì— ë…¸ì¶œí•˜ê¸° ìœ„í•´ ì‚¬ìš© (ë¼ìš°íŒ… ê¸°ëŠ¥)

â†’ overlay ë„¤íŠ¸ì›Œí¬ ë“œë¼ì´ë²„

â†’ ìŠ¤ì›œ ì„œë¹„ìŠ¤ì™€ ê´€ë ¨ëœ ë°ì´í„° íŠ¸ë˜í”½ í†µì œ

â†’ swarm ì„œë¹„ìŠ¤ì˜ ê¸°ë³¸ ë„¤íŠ¸ì›Œí¬ ë“œë¼ì´ë²„(default bridge ì™€ ê°™ìŒ)ë¡œ ì„œë¹„ìŠ¤ ìƒì„± ì‹œ ë„¤íŠ¸ì›Œí¬ ì •ë³´ë¥¼ ì§€ì •í•˜ì§€ ì•ŠëŠ”ë‹¤ë©´ ìë™ìœ¼ë¡œ ingress ë„¤íŠ¸ì›Œí¬ì— ì—°ê²°ë¨

2ï¸âƒ£ docker_gwbridgebridge ë„¤íŠ¸ì›Œí¬ ë“œë¼ì´ë²„

â†’ ìŠ¤ì›œì— ì°¸ì—¬í•œ ë„ì»¤ ë°ëª¬ë“¤ì„ ì—°ê²°í•´ ì£¼ëŠ” ì—­í• 
â†’ ë¶„ì‚° í™˜ê²½ì— ì°¸ì—¬í•œ í˜¸ìŠ¤íŠ¸ë“¤ ì—°ê²°

```python
#p.221
docker service create --name hostname -p 80:80 --replicas=4 alicek106/book:hostname

```
